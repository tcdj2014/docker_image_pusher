name: Docker Python Build ubuntu bin

on:
    workflow_dispatch:
    push:
        branches: [ main ]
        paths:
            - '.github/workflows/archive.yaml'
            - 'py/archive/*'
    schedule:
        -   cron: '00 4 * * *'

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            -   uses: actions/checkout@v4

            -   name: Build in manylinux2014 container
                run: |
                    cd  py/archive
                    pwd
                    docker run --rm \
                      -v "$PWD:/src" \
                      quay.io/pypa/manylinux2014_x86_64 \
                      bash -c "
                          set -eux
                      
                          PYTHON=/opt/python/cp311-cp311/bin/python
                          PIP=/opt/python/cp311-cp311/bin/pip
                      
                          # 只用 manylinux 自带 pip
                          \$PIP install --upgrade pip
                          \$PIP install pyinstaller
                      
                          # 校验 Python 是否 shared build（必须是 1）
                          \$PYTHON - <<EOF
                          import sys, sysconfig
                          print(sys.executable)
                          print('Py_ENABLE_SHARED =', sysconfig.get_config_var('Py_ENABLE_SHARED'))
                          EOF
                      
                          cd /src
                      
                          # ⚠️ build.py 也必须用这个 python
                          \$PYTHON build.py
                      "

            -   uses: actions/upload-artifact@v4
                with:
                    name: wms-archive-tool-linux-manylinux
                    path: py/archive/dist/*